- name: install git
  package:
    name: git
    state: present

- name: install oasis repos
  git:
    repo: "git://github.com/{{ item.user }}/{{ item.repo }}.git"
    version: "{{ item.version }}"
    depth: 1
    dest: "/home/{{ admin_user }}/{{ item.repo }}"
    force: yes
  with_items:
    - { user: "{{ git_user_api }}", repo: "{{ git_repo_api }}", version: "{{ git_version_api }}" }
    - { user: "{{ git_user_ui }}", repo: "{{ git_repo_ui }}", version: "{{ git_version_ui }}" }
    - { user: "{{ git_user_piwind }}", repo: "{{ git_repo_piwind }}", version: "{{ git_version_piwind }}" }

- name: pull oasis api docker images [bypass docker-compose bug - https://github.com/ansible/ansible/issues/47978 - remove this task when fixed in docker-compose v1.24]
  docker_image:
    name: "{{ item }}"
  with_items: 
    - "coreoasis/api_server:latest"
    - "coreoasis/model_worker:latest"
    - "mysql"
    - "rabbitmq:3-management"
    - "iserko/docker-celery-flower"

- name: run oasis api container
  docker_service:
    project_src: "/home/{{ admin_user }}/{{ git_repo_api }}"
    pull: yes
  environment:
    OASIS_MODEL_DATA_DIR: "/home/{{ admin_user }}/{{ git_repo_piwind }}"
  register: oasis_api_output

# - name: docker-compose debug - oasis api
#   debug:
#     var: oasis_api_output

- name: create docker network shiny-net
  docker_network:
    name: "{{ docker_network }}"

- name: pull oasis ui app docker image
  docker_image:
    name: "coreoasis/oasisui_app:latest"

- name: pull oasis ui docker images [bypass docker-compose bug - https://github.com/ansible/ansible/issues/47978 - remove this task when fixed in docker-compose v1.24]
  docker_image:
    name: "{{ item }}"
  with_items: 
    - "coreoasis/oasisui_proxy:latest"

- name: run oasis ui container
  docker_service:
    project_src: "/home/{{ admin_user }}/{{ git_repo_ui }}"
    pull: yes
  register: oasis_ui_output

# - name: docker-compose debug - oasis ui
#   debug:
#     var: oasis_ui_output
